# Stata do 文件转 Jupyter Notebook 提示词模板

## 任务说明

请将我提供的 'Stata do 文件' 或 '一段 Stata 代码' 转换为 Jupyter Notebook (.ipynb) 格式，用于在 VSCode 中通过 nbstata 插件执行。  
我随后会通过 Quarto render 编译为在线中文讲义。

---

## 转换规划（针对长 do 文件）

**如果 do 文件较长（超过 100 行代码），请先提供切割规划：**

1. **文件拆分方案**
   - 建议拆分为几个独立的 notebook？
   - 每个 notebook 的主题和范围是什么？
   - 文件命名建议 （要有统一的逻辑）：
     - 如果 dofile 有多个区分度较大的功能模块，则按此逻辑命名：`01_data_cleaning.ipynb`, `02_descriptive_stats.ipynb` 等等。
     - 如果功能模块不明显，则细分功能，命名思路为：`01_graph_01_histogram.ipynb`, `01_graph_02_scatterplot.ipynb` 等等。
       

2. **单个 notebook 的结构预览**
   - 预计包含多少个代码块？
   - 预计包含多少个 markdown 文本块？
   - 主要章节标题是什么？

**请在提供规划后，询问我是否同意该方案，再开始实际转换。**

---

## 代码块切割规则

### 基本原则
- **长度控制**：每个代码块建议 5-10 行；若有嵌套循环语句、条件判断、复杂的图形绘制等，可适当放宽，但不宜超过 50 行。 
- **功能独立**：每个代码块应完成一个独立的小任务
- **逻辑连贯**：相关操作可以放在同一块，但要避免混杂不同主题

### 具体切割标准

1. **数据操作类**
   ```stata
   // ✅ 好的切割示例
   // Block 1: 数据导入
   use "data.dta", clear
   
   // Block 2: 变量生成
   gen log_wage = log(wage)
   label variable log_wage "对数工资"
   
   // Block 3: 样本筛选
   keep if age >= 18 & age <= 65
   drop if missing(wage)
   ```

2. **回归分析类**
   - 每个回归模型单独成块
   - 回归前的变量准备单独成块
   - 结果展示（如 `esttab`）单独成块

3. **绘图类（重要！）**
   - **每个图形必须单独成块**
   - 原因：nbstata 只能自动捕获代码块的最后一个图形
   - 如果一个块有多个绘图命令，前面的图会丢失
   
   ```stata
   // ❌ 错误示例（会丢失第一个图）
   histogram wage
   histogram age
   
   // ✅ 正确示例
   // Block 1
   histogram wage
   
   // Block 2  
   histogram age
   ```

4. **循环和条件语句**
   - 简单循环（<10 次迭代）可以保持完整
   - 复杂循环建议拆分或在前面用文字说明逻辑

5. **输出结果的控制**
    - 输出结果（如 `summarize`, `tabulate`）可以与前面的数据处理放在同一块
    - 但如果输出结果较多，建议单独成块，并在前后添加说明文字
    - 适当控制输出量，避免冗长：
      - 仅输出关键结果。因此，诸如 `gen`, `list` 等命令如果输出过多，已自动在命令前添加 quie (注意：请写成 'quie'，以方便我随后统一替换，以便控制是否输出)。

---

## Markdown 文本块要求

### 内容结构

1. **开篇导言**
   - 包含 notebook 标题（H1）
   - 简要说明本文档的目的和内容概览
   - 可以用列表形式列出主要内容

2. **章节标题**
   - 使用 H2 (`##`) 标记主要章节
   - 使用 H3 (`###`) 标记子章节
   - 标题要简洁有力，突出重点

3. **代码说明**（每个代码块前）
   - 用 1-3 句话说明代码的作用
   - 如果涉及算法或公式，简要解释原理
   - 必要时说明参数含义或选项用途

4. **结果解读**（某些代码块后）
   - 对于统计输出，提供简要解读
   - 对于图形，说明观察要点
   - 不需要过度解释，点到为止

### 写作风格

- **简洁明了**：每个文本块 2-5 句话为宜，避免冗长
- **中文讲义风格**：学术但不刻板，清晰但不啰嗦
- **突出要点**：用**加粗**标记关键概念（适度使用）
- **列表优先**：对于步骤、要点、注意事项等，优先使用列表形式

### 列表使用指南

**适合使用列表的场景：**
- 操作步骤说明
- 算法流程描述  
- 参数/选项说明
- 注意事项提示
- 内容概览总结

**示例：**
```markdown
### 数据清洗步骤

本节执行以下操作：
1. 删除缺失值超过 50% 的观测
2. 对极端值进行 winsorize 处理（1% 和 99% 分位数）
3. 生成标准化变量用于后续分析
```

### 中英文混排和标点符号

- 中文环境下，优先使用中文标点符号，如 '，。！？；：“”‘’（）——《》【】等'
- 英文术语、代码、变量名等使用英文标点
- 全文中的圆括号都是用英文括号 `()`，如 '王明 (2025) 发现...'
- 中英文混排时合理使用空格，提升可读性

### callout 框

- 适当使用 callout 框（提示框）来强调重要信息
- 例如：注意事项、常见错误、最佳实践等
- 使用 Quarto 语法：
```markdown
::: {.callout-note}
## 注意事项
- 确保数据路径正确
- 预先安装所需的 Stata 外部命令
:::
```
- 避免过度使用，保持内容简洁
- 主要类别：
  - 注意事项（note）
  - 警告（warning）
  - 提示（tip）
  - 重要信息（important）

---

## 数学公式规范

### 何时使用公式

- 涉及统计模型（回归、检验等）时
- 需要说明计算原理时
- 公式能比文字更清晰地表达时

### LaTeX 公式语法

1. **行内公式**：用单个 `$` 包围
   ```markdown
   回归系数 $\beta$ 的标准误为 $SE(\hat{\beta})$
   ```

2. **独立公式块**：用双 `$$` 包围，上下各空一行
   ```markdown
   $$
   Y_i = \beta_0 + \beta_1 X_i + \varepsilon_i
   $$
   ```

3. **常见符号注意事项**
   - 下划线需转义：`\text{ttl\_exp}` 而非 `\text{ttl_exp}`
   - 使用 `\text{}` 包裹英文文字
   - 希腊字母：`\alpha, \beta, \gamma, \varepsilon`
   - 数学符号：`\hat{}, \bar{}, \sum, \prod`

### 公式示例模板

```markdown
**OLS 回归模型：**

$$
\log(\text{wage}_i) = \beta_0 + \beta_1 \text{educ}_i + \beta_2 \text{exper}_i + \varepsilon_i
$$

其中：
- $\text{wage}_i$：个体 $i$ 的工资
- $\text{educ}_i$：受教育年限
- $\text{exper}_i$：工作经验
- $\varepsilon_i$：随机误差项
```

---

## 特殊处理说明

### 注释处理
- 保留原始 do 文件中的重要注释
- 将注释内容转换为 markdown 文字说明
- 删除纯粹的分隔线注释（如 `*---`）

### 外部命令
- 如果代码使用了外部命令（如 `ssc install`），在文本块中说明
- 提示用户可能需要预先安装

### 路径问题
- 如果涉及文件路径，考虑改为相对路径
- 或在文本块中说明用户需要修改路径

---

## 最终输出要求

1. **文件格式**：标准的 `.ipynb` JSON 格式
2. **kernel 配置**：设置为 Stata kernel
3. **编码**：UTF-8 编码，确保中文正常显示
4. **可执行性**：确保可以在 VSCode + nbstata 环境中直接运行
5. **Quarto 兼容**：确保格式符合 Quarto 渲染要求

---

## 使用示例

**输入（do 文件内容）：**
```
附上你的 do 文件内容或文件路径
```

**期望输出：**
- 对于短文件（<100 行）：直接生成单个 `.ipynb` 文件
- 对于长文件（>100 行）：先提供拆分方案，确认后再生成多个文件

---

## 补充说明

- 如果原始 do 文件包含中文注释，请保留并整合到 markdown 文本块中
- 如果代码有明显的逻辑错误或过时语法，可以指出但不擅自修改
- 优先保证代码的可执行性，其次考虑美观性

---

**准备好后，请直接粘贴你的 do 文件内容，或上传 do 文件。**
